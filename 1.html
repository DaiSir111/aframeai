<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>A-Frame AR 演示</title>
  
  <!-- 使用兼容的版本组合 -->
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
  
  <style>
    body { margin: 0; overflow: hidden; }
    .loading { 
      position: fixed; 
      top: 50%; 
      left: 50%; 
      transform: translate(-50%, -50%); 
      color: white; 
      background: rgba(0,0,0,0.7); 
      padding: 20px; 
      border-radius: 10px;
      z-index: 1000;
    }
  </style>
</head>
<body>
  <!-- 加载提示 -->
  <div id="loading" class="loading">正在加载AR体验...</div>
  
  <!-- 修复后的AR场景 -->
  <a-scene 
    arjs="
      sourceType: webcam;
      detectionMode: mono_and_matrix;
      matrixCodeType: 3x3;
      debugUIEnabled: false;
    " 
    embedded
    renderer="logarithmicDepthBuffer: true;"
  >
    <!-- 相机配置 -->
    <a-entity
      camera
      arjs-camera="
        far: 1000;
        near: 0.1;
      "
      wasd-controls="enabled: false"
      look-controls="enabled: false"
    ></a-entity>

    <!-- Hiro标记 -->
    <a-marker 
      type="pattern" 
      preset="hiro"
      emitevents="true"
      id="marker"
    >
      <a-entity 
        gltf-model="demo/26380429b7334e1ea9723d2d858b921d.gltf"
        position="0 0 0"
        scale="0.01 0.01 0.01"
        rotation="0 0 0"
        animation="property: rotation; to: 0 360 0; loop: true; dur: 5000"
      >
        <!-- 加载失败时的备用显示 -->
        <a-box 
          position="0 0 0" 
          scale="1 1 1" 
          color="#FF0000" 
          visible="false"
          id="fallbackModel"
        ></a-box>
      </a-entity>
    </a-marker>

    <!-- 标记未找到时的提示 -->
    <a-entity 
      id="noMarkerMessage" 
      position="0 1.5 -2" 
      scale="1.5 1.5 1.5" 
      visible="true"
      text="value: 请将摄像头对准HIRO标记; align: center; color: white; width: 5"
    ></a-entity>

  </a-scene>

  <script>
    // 错误处理和调试
    console.log('AR页面初始化');
    
    // 模型加载处理
    const scene = document.querySelector('a-scene');
    
    scene.addEventListener('loaded', function() {
      console.log('A-Frame场景加载完成');
      document.getElementById('loading').style.display = 'none';
    });

    // 模型加载事件监听
    const model = document.querySelector('[gltf-model]');
    
    model.addEventListener('model-loaded', function() {
      console.log('GLTF模型加载成功');
      document.getElementById('fallbackModel').setAttribute('visible', 'false');
    });

    model.addEventListener('model-error', function(e) {
      console.error('模型加载失败:', e.detail);
      document.getElementById('fallbackModel').setAttribute('visible', 'true');
      
      // 尝试不同的路径格式
      setTimeout(() => {
        console.log('尝试备用路径...');
        model.setAttribute('gltf-model', './demo/26380429b7334e1ea9723d2d858b921d.gltf');
      }, 2000);
    });

    // 标记检测事件
    const marker = document.getElementById('marker');
    const message = document.getElementById('noMarkerMessage');
    
    marker.addEventListener('markerFound', function() {
      console.log('标记找到');
      message.setAttribute('visible', 'false');
    });
    
    marker.addEventListener('markerLost', function() {
      console.log('标记丢失');
      message.setAttribute('visible', 'true');
    });

    // 检查控制台错误
    window.addEventListener('error', function(e) {
      console.error('全局错误:', e.error);
    });
  </script>
</body>
</html>